
-module(twt2).

-compile(export_all).

-include_lib("erleen.hrl").

reconfig(Top) ->
    Config =
        {#een_component_spec{id = top,
                             version = unchanged,
                             module = twt_top,
                             node = make_node(w1)},
         #een_children_config{
             version = changed,
             children = [{#een_component_spec{id = bob,
                                              version = unchanged,
                                              module = twt_random_twtr,
                                              args = ["Bob"],
                                              node = make_node(w5)},
                          #een_children_config{version = unchanged}},
                         {#een_component_spec{id = joe,
                                              version = new,
                                              module = twt_random_twtr,
                                              args = ["Joe"],
                                              node = make_node(w4)},
                          #een_children_config{version = new}},
                         {#een_component_spec{id = ann,
                                              version = new,
                                              module = twt_random_twtr,
                                              args = ["Ann"],
                                              node = make_node(w3)},
                          #een_children_config{version = new}},
                         {#een_component_spec{id = twtr,
                                              version = unchanged,
                                              module = twt_base,
                                              node = make_node(w1)},
                          #een_children_config{
                              version = changed,
                              children = [{#een_component_spec{id = store,
                                                               version = unchanged,
                                                               module = twt_store,
                                                               node = make_node(w2)},
                                           #een_children_config{version = unchanged}},
                                          {#een_component_spec{id = users,
                                                               version = unchanged,
                                                               module = twt_users,
                                                               node = make_node(w2)},
                                           #een_children_config{version = unchanged}},
                                          {#een_component_spec{id = call_split,
                                                               version = unchanged,
                                                               module = call_splitter,
                                                               args = [2],
                                                               node = make_node(w1)},
                                           #een_children_config{version = unchanged}},
                                          {#een_component_spec{id = stats,
                                                               version = changed,
                                                               module = twt_stats2,
                                                               node = make_node(w1)},
                                           #een_children_config{version = unchanged}},
                                          {#een_component_spec{id = tracer,
                                                               version = unchanged,
                                                               module = twt_tracer,
                                                               args = [2, 100],
                                                               node = make_node(w1)},
                                           #een_children_config{version = unchanged}}],
                              bindings = [{{twtr, new_user}, {users, new_user}},
                                          {{twtr, follow}, {users, follow}},
                                          {{twtr, get_followed_tweets}, {store, get_followed_tweets}},
                                          {{twtr, tweet}, {call_split, in_call}},
                                          {{call_split, out_call}, {store, tweet}},
                                          {{call_split, out_cast}, {stats, tweet}},
                                          {{call_split, out_cast}, {tracer, msg}}]}}],
             bindings = [{{top, start}, {bob, start}},
                         {{bob, new_user}, {twtr, new_user}},
                         {{bob, tweet}, {twtr, tweet}},
                         {{top, start}, {joe, start}},
                         {{joe, new_user}, {twtr, new_user}},
                         {{joe, tweet}, {twtr, tweet}},
                         {{top, start}, {ann, start}},
                         {{ann, new_user}, {twtr, new_user}},
                         {{ann, tweet}, {twtr, tweet}}]}},
    ok = een:reconfig(Top, Config),
    een_gen:cast(Top, {msg, start, {undefined, undefined}, {}}),
    {ok, Top}.

make_node(N) ->
    list_to_atom(atom_to_list(N) ++ "@" ++ net_adm:localhost()).
